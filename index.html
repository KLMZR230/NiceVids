<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoApp Móvil - Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000;
            overflow: hidden;
            touch-action: pan-y;
        }
        /* Estilos específicos para el feed de videos */
        #video-feed {
            height: calc(100vh - 56px);
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            -webkit-overflow-scrolling: touch;
        }
        .video-container {
            width: 100vw;
            height: calc(100vh - 56px);
            scroll-snap-align: start;
            position: relative;
            background-color: #000;
        }
        .video-element {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Degradado más sutil y funcional en la parte superior e inferior */
            background: linear-gradient(to top, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0) 30%, rgba(0,0,0,0) 70%, rgba(0,0,0,0.2) 100%);
            pointer-events: none;
        }
        /* Clase para los botones de acción */
        .icon-btn {
            pointer-events: auto;
            transition: transform 0.2s, color 0.2s;
            filter: drop-shadow(0 0 3px rgba(0,0,0,0.8)); /* Sombra para resaltar sobre el video */
        }
        .icon-btn:active {
            transform: scale(0.9);
        }
        /* Animación y estilo para el icono de Play/Pause */
        #play-pause-icon {
            opacity: 0;
            transition: opacity 0.2s;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }
        .show-icon {
            opacity: 1 !important;
        }
        /* Animaciones para modales */
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-slide-up {
            animation: slide-up 0.3s ease-out forwards;
            transform: translateY(100%);
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        .text-shadow-strong {
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.7), 0 0 15px rgba(0, 0, 0, 0.4);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-white">

    <div id="app" class="flex flex-col h-screen">

        <header class="fixed top-0 w-full z-20 flex justify-center p-3">
            <div class="text-shadow-strong">
                <span class="text-gray-400 font-semibold mx-4 cursor-pointer hover:text-white transition">Siguiendo</span>
                <span class="text-white font-extrabold mx-4 border-b-2 border-white pb-1 cursor-pointer">Para Ti</span>
            </div>
        </header>

        <div id="video-feed" class="flex-grow">
            <div class="video-container flex items-center justify-center">
                <p class="text-xl">Cargando el feed...</p>
            </div>
        </div>

        <nav id="bottom-nav" class="flex justify-around items-center h-14 bg-black/90 border-t border-gray-800 fixed bottom-0 w-full z-10 backdrop-blur-sm">
            <button class="flex flex-col items-center text-white text-xs font-bold transition">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 5.69l5-4.5V21h-2V10h-2v11H7V1.19l5 4.5z"/></svg>
                <span>Inicio</span>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-white text-xs transition" onclick="handleExplore()">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM9.5 14C7.57 14 6 12.43 6 10.5S7.57 7 9.5 7 13 8.57 13 10.5 11.43 14 9.5 14z"/></svg>
                <span>Explorar</span>
            </button>
            <button class="w-12 h-8 bg-white text-black rounded-lg flex items-center justify-center font-bold text-xl transition hover:bg-red-500 hover:text-white shadow-md shadow-gray-700" onclick="openUploadModal()">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            </button>
            <button class="flex flex-col items-center text-gray-400 hover:text-white text-xs transition" onclick="handleInbox()">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10z"/></svg>
                <span>Buzón</span>
            </button>
            <button id="profile-btn" class="flex flex-col items-center text-gray-400 hover:text-white text-xs transition">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <span id="auth-status">Perfil</span>
            </button>
        </nav>

        <div id="comments-modal" class="fixed inset-0 bg-black bg-opacity-80 z-20 hidden items-end" onclick="closeModal('comments-modal')">
            <div class="bg-gray-900 w-full h-1/2 p-4 rounded-t-xl animate-slide-up" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Comentarios (32)</h3>
                    <button class="text-gray-400 text-3xl" onclick="closeModal('comments-modal')">&times;</button>
                </div>
                <div class="space-y-3 overflow-y-auto h-4/5 pb-4">
                    <p><span class="font-bold text-sm text-red-400">@UsuarioPro:</span> ¡Increíble! ¿Dónde grabaste esto?</p>
                    <p><span class="font-bold text-sm text-yellow-400">@viajero_x:</span> Necesito el tutorial completo.</p>
                    <p><span class="font-bold text-sm text-blue-400">@AnaM:</span> Me encantó el soundtrack.</p>
                    <p class="text-gray-500 text-sm">... 29 comentarios más ...</p>
                </div>
                <div class="mt-2 border-t border-gray-800 pt-2">
                    <input type="text" placeholder="Añade un comentario profesional..." class="w-full p-2 bg-gray-800 text-white rounded-full focus:outline-none focus:ring-2 focus:ring-red-500">
                </div>
            </div>
        </div>

        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-80 z-30 hidden items-center justify-center" onclick="closeModal('auth-modal')">
            <div class="bg-gray-900 w-11/12 max-w-sm p-6 rounded-xl shadow-2xl animate-fade-in" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold mb-4 text-center">Gestión de Cuenta</h3>
                <p class="text-gray-400 text-center mb-6">Usa tu cuenta para interactuar y personalizar tu feed.</p>

                <div id="login-section">
                    <input type="email" id="auth-email" placeholder="Correo Electrónico" class="w-full p-3 mb-3 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" value="test@example.com">
                    <input type="password" id="auth-password" placeholder="Contraseña" class="w-full p-3 mb-6 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" value="password123">

                    <button class="w-full py-3 mb-3 bg-red-600 hover:bg-red-700 rounded-full font-bold transition duration-200" onclick="performLogin()">
                        Iniciar Sesión
                    </button>
                    <button class="w-full py-3 mb-3 bg-red-900 hover:bg-red-800 rounded-full font-bold transition duration-200" onclick="performSignUp()">
                        Registrarse
                    </button>
                    
                    <button class="w-full py-3 bg-gray-600 hover:bg-gray-700 rounded-full font-bold transition duration-200" onclick="handleAuthAction('anon')">
                        Continuar como Invitado
                    </button>
                </div>

                <div id="logout-section" class="hidden">
                    <p class="text-center mb-4 text-sm text-gray-300">Usuario ID: <span id="current-user-id" class="font-mono text-xs">Cargando...</span></p>
                    <button class="w-full py-3 bg-red-600 hover:bg-red-700 rounded-full font-bold transition duration-200" onclick="handleAuthAction('logout')">
                        Cerrar Sesión
                    </button>
                </div>

                <button class="absolute top-3 right-3 text-gray-400 text-3xl" onclick="closeModal('auth-modal')">&times;</button>
            </div>
        </div>
        
        <div id="upload-modal" class="fixed inset-0 bg-black bg-opacity-80 z-40 hidden items-center justify-center" onclick="closeModal('upload-modal')">
            <div class="bg-gray-900 w-11/12 max-w-lg p-6 rounded-xl shadow-2xl animate-fade-in" onclick="event.stopPropagation()">
                <h3 class="text-2xl font-bold mb-6 text-center">Subir Nuevo Video</h3>
                
                <input type="file" id="video-file-input" accept="video/mp4,video/quicktime" class="w-full p-3 mb-4 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 border border-dashed border-gray-600">
                
                <input type="text" id="video-description-input" placeholder="Descripción del video (p. ej., #viaje #tutorial)" class="w-full p-3 mb-4 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                
                <input type="text" id="video-music-input" placeholder="Música / Sonido Original" class="w-full p-3 mb-6 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500" value="Música Custom">

                <button id="upload-btn" class="w-full py-3 bg-red-600 hover:bg-red-700 rounded-full font-bold transition duration-200 flex items-center justify-center" onclick="uploadVideo()">
                    Subir Video
                </button>
                
                <p id="upload-status" class="text-center text-sm mt-3 text-gray-400 hidden"></p>

                <button class="absolute top-3 right-3 text-gray-400 text-3xl" onclick="closeModal('upload-modal')">&times;</button>
            </div>
        </div>


        <div id="play-pause-icon" class="fixed inset-0 flex items-center justify-center z-40 pointer-events-none">
            <svg class="w-20 h-20 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
            </svg>
        </div>

    </div>

    <script type="module">
        // Importación del cliente de Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.2/+esm';

        // =================================================================
        // CREDENCIALES DE SUPABASE (PROPORCIONADAS POR EL USUARIO)
        // =================================================================
        const SUPABASE_URL = 'https://fcpczyohzcgulbfpthuc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjcGN6eW9oemNndWxiZnB0aHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDA4NzksImV4cCI6MjA3Njk3Njg3OX0.Ya3sJ2Hb0gr8pCg5CEheMDWGjSCAuPeoNcfANUTuwPk';
        const SUPABASE_TABLE_NAME = 'videos'; 
        const SUPABASE_STORAGE_BUCKET = 'videos-bucket'; // Asumiendo este nombre de bucket

        // Variables de Supabase
        let supabase;
        let currentUserId = null;
        let likedVideoIds = new Set(); 

        // Elementos del DOM
        const videoFeed = document.getElementById('video-feed');
        const authStatusElement = document.getElementById('auth-status');
        const profileBtn = document.getElementById('profile-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const currentUserIdElement = document.getElementById('current-user-id');
        const uploadStatusElement = document.getElementById('upload-status');
        const uploadBtn = document.getElementById('upload-btn');

        // Mock de datos de videos (URLs directas y funcionales)
        const mockVideoData = [
            {
                id: 1,
                user: 'AventureroMX',
                description: 'La vista más increíble del Popocatépetl hoy. 🌋',
                music: 'Sonido Original - México Mágico',
                video_url: 'https://cdn.pixabay.com/vimeo/374528131/road-25752.mp4?width=1280&hash=85e8d88e0e56f4551d451421f5be634563a92377', 
                likes: 1200, comments: 32, shares: 15, isLikedByCurrentUser: false,
            },
            {
                id: 2,
                user: 'CodeMaster',
                description: '¡Tip de Tailwind CSS que te ahorrará horas! #programacion #webdev',
                music: 'Synthwave - The Programmer',
                video_url: 'https://cdn.pixabay.com/vimeo/459039396/programming-48532.mp4?width=1280&hash=0c2794c1f64f5efd2c67b253b544321685121332',
                likes: 850, comments: 18, shares: 5, isLikedByCurrentUser: true,
            },
            {
                id: 3,
                user: 'FitnessLatam',
                description: 'Rutina rápida para abdomen de acero. ¡Sin excusas!',
                music: 'Ritmo Electrónico',
                video_url: 'https://cdn.pixabay.com/vimeo/538059082/gym-80128.mp4?width=1280&hash=b578c74075b9f7a77d70428383a15291b8f10609',
                likes: 3400, comments: 112, shares: 50, isLikedByCurrentUser: false,
            }
        ];
        let videoData = [...mockVideoData];

        // =================================================================
        // LÓGICA DE AUTENTICACIÓN (SUPABASE)
        // =================================================================

        /**
         * Obtiene los IDs de videos a los que el usuario ha dado like.
         */
        async function fetchLikedVideoIds(userId) {
            if (!supabase || userId.startsWith('guest_')) {
                likedVideoIds = new Set();
                return;
            }
            try {
                const { data, error } = await supabase
                    .from('video_likes')
                    .select('video_id')
                    .eq('user_id', userId);

                if (error) throw error;
                
                likedVideoIds = new Set(data.map(item => item.video_id));

            } catch (error) {
                console.error("Error al obtener likes del usuario:", error);
            }
        }

        async function initializeSupabase() {
            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Cliente Supabase inicializado y conectado.");

                supabase.auth.onAuthStateChange(async (event, session) => {
                    if (session && session.user) {
                        currentUserId = session.user.id;
                    } else {
                        currentUserId = 'guest_' + Math.random().toString(36).substring(2, 9);
                    }

                    await fetchLikedVideoIds(currentUserId); 
                    
                    updateAuthUI();
                    await subscribeToVideoFeed(); 
                });
                
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    currentUserId = 'guest_' + Math.random().toString(36).substring(2, 9);
                    updateAuthUI(); 
                    await subscribeToVideoFeed();
                }

            } catch (error) {
                console.error("Error al inicializar Supabase:", error);
                renderFeed(videoData);
            }
        }

        /**
         * Actualiza la interfaz de usuario basada en el estado de autenticación.
         */
        function updateAuthUI() {
            const loginSection = document.getElementById('login-section');
            const logoutSection = document.getElementById('logout-section');
            
            const isLoggedIn = currentUserId && !currentUserId.startsWith('guest_');

            if (isLoggedIn) {
                authStatusElement.textContent = 'Mi Perfil';
                profileBtn.classList.remove('text-gray-400');
                profileBtn.classList.add('text-white');
                if (loginSection) loginSection.classList.add('hidden');
                if (logoutSection) logoutSection.classList.remove('hidden');
                if (currentUserIdElement) currentUserIdElement.textContent = currentUserId;
            } else {
                authStatusElement.textContent = 'Perfil';
                profileBtn.classList.remove('text-white');
                profileBtn.classList.add('text-gray-400');
                if (loginSection) loginSection.classList.remove('hidden');
                if (logoutSection) logoutSection.classList.add('hidden');
                if (currentUserIdElement) currentUserIdElement.textContent = 'Modo Invitado';
            }
        }

        /**
         * Maneja el Registro (Sign Up) real de Supabase.
         */
        async function performSignUp() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (!email || !password || password.length < 6) {
                alertMessage('Ingresa un correo válido y una contraseña (mínimo 6 caracteres).', 'error');
                return;
            }
            
            uploadStatusElement.textContent = "Registrando usuario...";
            uploadStatusElement.classList.remove('hidden');

            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            user_handle: email.split('@')[0] 
                        }
                    }
                });

                if (error) {
                    throw error;
                }

                if (data.user && data.user.identities && data.user.identities.length > 0) {
                    alertMessage('¡Registro exitoso! Sesión iniciada.', 'success');
                    closeModal('auth-modal');
                } else {
                    alertMessage('¡Registro exitoso! Revisa tu correo electrónico para confirmar tu cuenta.', 'info');
                    closeModal('auth-modal');
                }

            } catch (error) {
                console.error(`Error de Registro:`, error);
                const errorMessage = error.message.includes('User already registered') ? 'Este correo ya está registrado.' : `Error: ${error.message}`;
                alertMessage(errorMessage, 'error');
            } finally {
                uploadStatusElement.classList.add('hidden');
            }
        }

        /**
         * Maneja el login real de Supabase con Email y Contraseña.
         */
        async function performLogin() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (!email || !password) {
                alertMessage('Ingresa correo y contraseña.', 'error');
                return;
            }
            
            uploadStatusElement.textContent = "Iniciando sesión...";
            uploadStatusElement.classList.remove('hidden');

            try {
                const { error } = await supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    throw error;
                }
                
                alertMessage('¡Sesión iniciada con éxito!', 'success');
                closeModal('auth-modal');

            } catch (error) {
                console.error(`Error de inicio de sesión:`, error);
                alertMessage(`Error: ${error.message}`, 'error');
            } finally {
                uploadStatusElement.classList.add('hidden');
            }
        }

        /**
         * Maneja las acciones de Logout/Anon.
         */
        async function handleAuthAction(action) {
            try {
                if (action === 'logout') {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    alertMessage('Sesión cerrada correctamente.', 'info');
                } else if (action === 'anon') {
                    alertMessage('Continuando en modo Invitado.', 'info');
                }
                closeModal('auth-modal');
            } catch (error) {
                console.error(`Error en acción de Auth (${action}):`, error);
                alertMessage(`Error de autenticación: ${error.message}`, 'error');
            }
        }

        // Abre el modal de autenticación
        profileBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openModal('auth-modal');
        });
        
        // =================================================================
        // LÓGICA DE SUBIDA DE VIDEOS
        // =================================================================

        function openUploadModal() {
            if (currentUserId.startsWith('guest_')) {
                alertMessage('Debes iniciar sesión para subir contenido.', 'error');
                openModal('auth-modal');
                return;
            }
            // Limpiar campos antes de abrir
            document.getElementById('video-file-input').value = '';
            document.getElementById('video-description-input').value = '';
            document.getElementById('video-music-input').value = 'Música Custom';
            uploadStatusElement.classList.add('hidden');
            openModal('upload-modal');
        }

        async function uploadVideo() {
            const fileInput = document.getElementById('video-file-input');
            const description = document.getElementById('video-description-input').value;
            const music = document.getElementById('video-music-input').value;
            const file = fileInput.files[0];

            if (!file || !description) {
                alertMessage('Por favor, selecciona un video y añade una descripción.', 'error');
                return;
            }
            if (!currentUserId || currentUserId.startsWith('guest_')) {
                alertMessage('Error: No hay usuario autenticado para subir el video.', 'error');
                return;
            }

            // Mostrar estado de carga
            uploadStatusElement.textContent = "Subiendo archivo... (0%)";
            uploadStatusElement.classList.remove('hidden');
            uploadBtn.innerHTML = '<div class="loading-spinner"></div>';
            uploadBtn.disabled = true;

            const fileExtension = file.name.split('.').pop();
            const fileName = `${currentUserId}/${Date.now()}.${fileExtension}`; 

            try {
                // 1. Subir a Supabase Storage
                const { data: storageData, error: storageError } = await supabase.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (storageError) throw storageError;

                // 2. Obtener URL pública
                const { data: publicUrlData } = supabase.storage
                    .from(SUPABASE_STORAGE_BUCKET)
                    .getPublicUrl(fileName);
                
                const videoUrl = publicUrlData.publicUrl;

                // 3. Insertar metadata en la tabla 'videos'
                const { error: dbError } = await supabase
                    .from(SUPABASE_TABLE_NAME)
                    .insert([{
                        user_id: currentUserId,
                        user_handle: 'UsuarioLogueado', // Debería obtenerse del perfil
                        description: description,
                        music: music,
                        video_url: videoUrl,
                        likes: 0,
                        comments: 0,
                        shares: 0
                    }]);
                
                if (dbError) throw dbError;

                alertMessage('¡Video subido y publicado con éxito!', 'success');
                closeModal('upload-modal');

            } catch (error) {
                console.error("Error de subida:", error);
                alertMessage(`Fallo en la subida: ${error.message}. Verifica permisos de Storage.`, 'error');
            } finally {
                uploadBtn.innerHTML = 'Subir Video';
                uploadBtn.disabled = false;
                uploadStatusElement.classList.add('hidden');
            }
        }


        // =================================================================
        // LÓGICA DE NAVEGACIÓN
        // =================================================================

        function handleExplore() {
            alertMessage('Mostrando contenido popular y tendencias (Explorar).', 'info');
        }

        function handleInbox() {
            if (currentUserId.startsWith('guest_')) {
                alertMessage('Debes iniciar sesión para ver tu buzón.', 'error');
                openModal('auth-modal');
                return;
            }
            alertMessage('Cargando notificaciones y mensajes (Buzón).', 'info');
        }

        // =================================================================
        // LÓGICA DE SUPABASE / INTERACCIÓN
        // =================================================================

        /**
         * Obtiene los datos de videos de Supabase (o usa el mock si falla).
         */
        async function subscribeToVideoFeed() {
            if (!supabase) {
                renderFeed(videoData);
                return;
            }

            try {
                const { data, error } = await supabase
                    .from(SUPABASE_TABLE_NAME)
                    .select('id, user_handle, description, music, video_url, likes, comments, shares');

                if (error) throw error;
                
                videoData = data.map(item => ({
                    id: item.id,
                    user: item.user_handle || 'Desconocido',
                    description: item.description || '',
                    music: item.music || 'Original Sound',
                    video_url: item.video_url || mockVideoData[0].video_url, 
                    likes: item.likes || 0,
                    comments: item.comments || 0,
                    shares: item.shares || 0,
                    isLikedByCurrentUser: likedVideoIds.has(item.id), 
                }));
                
                if (videoData.length === 0) {
                    console.warn("Supabase: No se encontraron videos, usando mock data.");
                    videoData = mockVideoData;
                }

                renderFeed(videoData);

            } catch (error) {
                console.warn("Error al obtener videos de Supabase. Usando mock data. Error:", error.message);
                if (videoData.length === 0) videoData = mockVideoData; 
                renderFeed(videoData);
            }
        }

        /**
         * Maneja el evento de dar "Me Gusta" (Integrado con Supabase).
         */
        async function handleLike(videoId, likeIcon, countElement) {
            const isLoggedIn = currentUserId && !currentUserId.startsWith('guest_');
            const userId = currentUserId;

            if (!isLoggedIn) {
                alertMessage('Debes iniciar sesión para dar Me Gusta.', 'error');
                openModal('auth-modal');
                return;
            }

            const video = videoData.find(v => v.id == videoId);
            if (!video) return;

            const isCurrentlyLiked = likedVideoIds.has(videoId); 
            let likeDelta = isCurrentlyLiked ? -1 : 1;

            // 1. Optimistic UI Update & Local State Update
            if (!isCurrentlyLiked) {
                likedVideoIds.add(videoId);
            } else {
                likedVideoIds.delete(videoId);
            }

            video.likes += likeDelta;
            video.isLikedByCurrentUser = !isCurrentlyLiked;
            
            countElement.textContent = formatNumber(video.likes);
            likeIcon.setAttribute('fill', !isCurrentlyLiked ? 'currentColor' : 'none');
            likeIcon.setAttribute('stroke', !isCurrentlyLiked ? 'none' : 'currentColor');
            likeIcon.classList.toggle('text-red-500', !isCurrentlyLiked);
            likeIcon.classList.add('scale-110');
            setTimeout(() => likeIcon.classList.remove('scale-110'), 200);

            // 2. Transacción de Base de Datos (Supabase)
            if (supabase) {
                try {
                    // 2a. Gestionar la tabla video_likes
                    if (!isCurrentlyLiked) {
                        const { error: insertError } = await supabase
                            .from('video_likes')
                            .insert([{ video_id: videoId, user_id: userId }]);
                        if (insertError) throw insertError;
                    } else {
                        const { error: deleteError } = await supabase
                            .from('video_likes')
                            .delete()
                            .eq('video_id', videoId)
                            .eq('user_id', userId);
                        if (deleteError) throw deleteError;
                    }

                    // 2b. Actualizar el contador de likes
                    const { error: updateError } = await supabase
                        .from(SUPABASE_TABLE_NAME)
                        .update({ likes: video.likes })
                        .eq('id', videoId);
                    
                    if (updateError) throw updateError;

                } catch (error) {
                    console.error("Error al gestionar like en Supabase:", error.message);
                    alertMessage('Error al guardar Me Gusta. Intenta de nuevo.', 'error');
                    
                    // 3. Revertir UI y estado local si falla
                    if (!isCurrentlyLiked) {
                        likedVideoIds.delete(videoId);
                    } else {
                        likedVideoIds.add(videoId);
                    }
                    video.likes -= likeDelta;
                    video.isLikedByCurrentUser = isCurrentlyLiked;

                    countElement.textContent = formatNumber(video.likes);
                    likeIcon.setAttribute('fill', isCurrentlyLiked ? 'currentColor' : 'none');
                    likeIcon.setAttribute('stroke', isCurrentlyLiked ? 'none' : 'currentColor');
                    likeIcon.classList.toggle('text-red-500', isCurrentlyLiked);
                }
            }
        }

        /**
         * Simula la acción de compartir.
         */
        function handleShare(videoId) {
            if (currentUserId.startsWith('guest_')) {
                 alertMessage('Debes iniciar sesión para compartir.', 'error');
                 openModal('auth-modal');
                 return;
            }
            document.execCommand('copy'); 
            alertMessage('¡Enlace del video copiado al portapapeles!', 'info');
        }

        /**
         * Abre el modal de comentarios.
         */
        function openComments(videoId) {
            if (currentUserId.startsWith('guest_')) {
                 alertMessage('Debes iniciar sesión para ver comentarios.', 'error');
                 openModal('auth-modal');
                 return;
            }
            openModal('comments-modal');
        }
        
        // =================================================================
        // LÓGICA DE REPRODUCCIÓN Y UTILIDADES
        // =================================================================

        /**
         * Maneja el tap/clic en el video para Pausar/Reproducir.
         */
        const tapVideo = (videoElement) => { 
            if (videoElement.paused) {
                videoElement.play().catch(e => console.error("Error al intentar reproducir:", e));
                showTemporaryIcon('pause'); 
            } else {
                videoElement.pause();
                showTemporaryIcon('play'); 
            }

            function showTemporaryIcon(action) {
                playPauseIcon.querySelector('svg path').setAttribute('d', action === 'play' ? 'M8 5v14l11-7z' : 'M6 19h4V5H6v14zm8-14v14h4V5h-4z');
                playPauseIcon.classList.add('show-icon');
                
                setTimeout(() => {
                    playPauseIcon.classList.remove('show-icon');
                }, 700);
            }
        }


        /**
         * Formatea números grandes a formato legible (e.g., 1200 -> 1.2K).
         */
        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        /**
         * Muestra un mensaje temporal tipo 'Toast' en la parte inferior.
         */
        function alertMessage(message, type = 'success') {
            const id = 'temp-alert';
            let alertBox = document.getElementById(id);
            if (!alertBox) {
                alertBox = document.createElement('div');
                alertBox.id = id;
                document.body.appendChild(alertBox);
            }

            let bgColor = type === 'error' ? 'bg-red-700' : (type === 'info' ? 'bg-blue-600' : 'bg-green-600');

            alertBox.className = `fixed bottom-20 left-1/2 transform -translate-x-1/2 px-5 py-3 rounded-full shadow-xl text-white font-semibold transition-opacity duration-300 z-50 opacity-100 ${bgColor}`;
            alertBox.textContent = message;

            setTimeout(() => {
                alertBox.classList.remove('opacity-100');
                alertBox.classList.add('opacity-0');
                setTimeout(() => alertBox.remove(), 300);
            }, 2500);
        }

        /**
         * Abre un modal.
         */
        function openModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = 'flex';
                const currentVideo = document.querySelector('.video-container video.active-video');
                if(currentVideo) currentVideo.pause();

                document.body.classList.add('overflow-hidden');
            }
        }

        /**
         * Cierra un modal.
         */
        function closeModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.style.display = 'none';
                const currentVideo = document.querySelector('.video-container video.active-video');
                 if(currentVideo && currentVideo.paused) currentVideo.play().catch(e => console.error("Error al intentar reanudar:", e));

                document.body.classList.remove('overflow-hidden');
            }
        }

        /**
         * Genera el HTML para un solo video.
         */
        function createVideoElement(videoData) {
            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = `video-${videoData.id}`;

            // Elemento de Video
            const videoEl = document.createElement('video');
            videoEl.className = 'video-element';
            videoEl.src = videoData.video_url; 
            videoEl.loop = true;
            videoEl.muted = true; 
            videoEl.setAttribute('playsinline', true);
            videoEl.setAttribute('data-id', videoData.id);

            videoEl.addEventListener('click', () => tapVideo(videoEl));

            // Overlay (Información y Controles)
            const overlay = document.createElement('div');
            overlay.className = 'overlay flex flex-col justify-end p-4'; 

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'flex justify-between items-end w-full';
            
            const likeActionId = videoData.id; 

            // 1. Contenido Inferior Izquierdo (Info del usuario/video)
            const textInfo = document.createElement('div');
            textInfo.className = 'text-white text-shadow-strong z-10 w-2/3';
            textInfo.innerHTML = `
                <p class="font-bold text-lg mb-1 hover:underline cursor-pointer">@${videoData.user}</p>
                <p class="text-sm mb-1">${videoData.description}</p>
                <p class="text-sm font-semibold flex items-center mt-2">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3v10.55a4 4 0 1 0 2 2.76V5h4V3h-6z"/></svg>
                    <span class="truncate">${videoData.music}</span>
                </p>
            `;
            contentWrapper.appendChild(textInfo);

            // 2. Contenido Inferior Derecho (Botones de acción)
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'flex flex-col items-center space-y-5 z-10';

            const isLiked = videoData.isLikedByCurrentUser;
            const likeClass = isLiked ? 'text-red-500' : 'text-white';
            const isFilled = isLiked ? 'currentColor' : 'none';
            const isStroked = isLiked ? 'none' : 'currentColor';

            actionsContainer.innerHTML = `
                <div class="flex flex-col items-center icon-btn" onclick="handleLike(${likeActionId}, this.querySelector('svg'), this.querySelector('span'))">
                    <svg class="w-8 h-8 ${likeClass} transition duration-150" fill="${isFilled}" stroke="${isStroked}" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <span class="text-xs font-semibold mt-1">${formatNumber(videoData.likes)}</span>
                </div>
                <div class="flex flex-col items-center icon-btn" onclick="openComments(${likeActionId})">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM20 4v11.75L18.75 15H4V4h16z"/></svg>
                    <span class="text-xs font-semibold mt-1">${formatNumber(videoData.comments)}</span>
                </div>
                <div class="flex flex-col items-center icon-btn" onclick="handleShare(${likeActionId})">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.52.47 1.2.77 1.96.77 1.38 0 2.5-1.12 2.5-2.5S19.38 3 18 3s-2.5 1.12-2.5 2.5c0 .24.04.47.09.7L8.55 9.88c-.52-.47-1.2-.77-1.96-.77-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5c.76 0 1.44-.3 1.96-.77l7.05 4.11c-.05.23-.09.46-.09.7 0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5z"/></svg>
                    <span class="text-xs font-semibold mt-1">${formatNumber(videoData.shares)}</span>
                </div>
                <div class="w-10 h-10 bg-red-500 rounded-full border-2 border-white cursor-pointer hover:scale-105 transition duration-150 flex items-center justify-center text-xs font-bold shadow-lg">
                    ${videoData.user.charAt(0)}
                </div>
            `;
            contentWrapper.appendChild(actionsContainer);

            overlay.appendChild(contentWrapper); 
            
            container.appendChild(videoEl);
            container.appendChild(overlay);

            return container;
        }

        /**
         * Renderiza el feed completo de videos.
         */
        function renderFeed(videos) {
            // 1. Pausa todos los videos antes de renderizar (limpieza)
            document.querySelectorAll('.video-element').forEach(v => v.pause());

            videoFeed.innerHTML = '';
            videos.forEach(video => {
                videoFeed.appendChild(createVideoElement(video));
            });

            // 2. Intenta reproducir el primer video y marcarlo como activo.
            const firstVideo = videoFeed.firstChild?.querySelector('video');
            if (firstVideo) {
                firstVideo.muted = false; 
                firstVideo.classList.add('active-video');
                firstVideo.play().catch(e => console.warn("Auto-reproducción bloqueada (tocar para iniciar).", e));
            }
        }

        /**
         * Maneja la lógica de reproducción/pausa al hacer scroll.
         */
        function handleScroll() {
            const videoContainers = document.querySelectorAll('.video-container');
            const viewportCenter = videoFeed.scrollTop + videoFeed.clientHeight / 2;

            videoContainers.forEach(container => {
                const video = container.querySelector('video');
                if (!video) return;

                const rect = container.getBoundingClientRect();
                const containerCenter = videoFeed.scrollTop + rect.top + rect.height / 2;

                const isVisibleAndCentered = Math.abs(viewportCenter - containerCenter) < rect.height / 3;
                
                video.classList.remove('active-video');

                if (isVisibleAndCentered) {
                    if (video.paused) {
                        video.play().catch(e => console.warn("Error al reproducir video:", e));
                    }
                    video.muted = false; 
                    video.classList.add('active-video'); 
                } else {
                    if (!video.paused) {
                        video.pause();
                        video.currentTime = 0;
                    }
                    video.muted = true; 
                }
            });
        }
        
        // =================================================================
        // EXPOSICIÓN GLOBAL DE FUNCIONES (Corrección del error 'is not defined')
        // =================================================================

        window.handleExplore = handleExplore;
        window.handleInbox = handleInbox;
        window.handleAuthAction = handleAuthAction;
        window.performLogin = performLogin;
        window.performSignUp = performSignUp;
        window.openUploadModal = openUploadModal;
        window.uploadVideo = uploadVideo; 
        window.openComments = openComments; 
        window.handleShare = handleShare;
        
        // CORRECCIÓN: Exponemos openModal y closeModal
        window.openModal = openModal;
        window.closeModal = closeModal; 

        // =================================================================
        // INICIALIZACIÓN
        // =================================================================

        window.addEventListener('load', async () => {
            // 1. Inicializa Supabase y carga los datos de video
            await initializeSupabase();
            
            // 2. Adjunta el event listener de scroll DESPUÉS de cargar los videos
            videoFeed.addEventListener('scroll', handleScroll);

            // 3. Llama a handleScroll una vez para asegurar que el video inicial se reproduzca 
            handleScroll(); 
        });

    </script>
</body>
</html>
